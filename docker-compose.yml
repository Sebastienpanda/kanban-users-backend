version: "3.9"

services:
    api:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: kanban-api
        restart: unless-stopped
        networks:
            - traefik-public
            - internal
        labels:
            - "traefik.enable=true"
            - "traefik.docker.network=traefik-public"


            - "traefik.http.routers.kanban-api-http.rule=Host(`api.kanban.kanbano.fr`)"
            - "traefik.http.routers.kanban-api-http.entrypoints=web"
            - "traefik.http.routers.kanban-api-http.middlewares=redirect-to-https"


            - "traefik.http.routers.kanban-api-https.rule=Host(`api.kanban.kanbano.fr`)"
            - "traefik.http.routers.kanban-api-https.entrypoints=websecure"
            - "traefik.http.routers.kanban-api-https.tls=true"
            - "traefik.http.routers.kanban-api-https.tls.certresolver=letsencrypt"


            - "traefik.http.services.kanban-api.loadbalancer.server.port=3000"


            - "traefik.http.services.kanban-api.loadbalancer.healthcheck.path=/api/health"
            - "traefik.http.services.kanban-api.loadbalancer.healthcheck.interval=30s"
            - "traefik.http.services.kanban-api.loadbalancer.healthcheck.timeout=3s"


            - "traefik.http.routers.kanban-api-https.middlewares=security-headers,rate-limit"


            - "traefik.http.middlewares.security-headers.headers.frameDeny=true"
            - "traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true"
            - "traefik.http.middlewares.security-headers.headers.browserXssFilter=true"
            - "traefik.http.middlewares.security-headers.headers.stsSeconds=31536000"
            - "traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true"
            - "traefik.http.middlewares.security-headers.headers.stsPreload=true"
            -
            - "traefik.http.middlewares.rate-limit.ratelimit.average=100"
            - "traefik.http.middlewares.rate-limit.ratelimit.burst=50"

    # Traefik Reverse Proxy
    traefik:
        image: traefik:v3.0
        container_name: traefik
        restart: unless-stopped
        security_opt:
            - no-new-privileges:true
        ports:
            - "80:80"
            - "443:443"
        environment:
            # Let's Encrypt configuration
            - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-admin@kanbano.fr}
        command:
            # API et Dashboard (à désactiver en production si non nécessaire)
            - "--api.dashboard=true"
            - "--api.insecure=false"

            # Providers
            - "--providers.docker=true"
            - "--providers.docker.exposedbydefault=false"
            - "--providers.docker.network=traefik-public"

            # Entrypoints
            - "--entrypoints.web.address=:80"
            - "--entrypoints.websecure.address=:443"

            # Certificats SSL avec Let's Encrypt
            - "--certificatesresolvers.letsencrypt.acme.tlschallenge=true"
            - "--certificatesresolvers.letsencrypt.acme.email=${LETSENCRYPT_EMAIL:-admin@kanbano.fr}"
            - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"

            # Logs
            - "--log.level=INFO"
            - "--accesslog=true"

            # Métriques (optionnel)
            - "--metrics.prometheus=true"

        volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro
            - traefik-certificates:/letsencrypt
        networks:
            - traefik-public
        labels:
            # Dashboard Traefik (optionnel - à sécuriser avec basic auth)
            - "traefik.enable=true"
            - "traefik.http.routers.traefik-dashboard.rule=Host(`traefik.kanban.kanbano.fr`)"
            - "traefik.http.routers.traefik-dashboard.entrypoints=websecure"
            - "traefik.http.routers.traefik-dashboard.tls=true"
            - "traefik.http.routers.traefik-dashboard.tls.certresolver=letsencrypt"
            - "traefik.http.routers.traefik-dashboard.service=api@internal"
            # Basic Auth pour le dashboard (user:password - à changer!)
            # Générer avec: echo $(htpasswd -nb admin votreMotDePasse) | sed -e s/\\$/\\$\\$/g
            - "traefik.http.routers.traefik-dashboard.middlewares=dashboard-auth"
            - "traefik.http.middlewares.dashboard-auth.basicauth.users=admin:$$apr1$$xxx" # À CHANGER !

            # Middleware de redirection HTTP -> HTTPS (global)
            - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
            - "traefik.http.middlewares.redirect-to-https.redirectscheme.permanent=true"

networks:
    # Réseau public (accessible par Traefik)
    traefik-public:
        name: traefik-public
        driver: bridge

    # Réseau interne (isolé)
    internal:
        name: kanban-internal
        driver: bridge
        internal: true

volumes:
    # Certificats SSL persistants
    traefik-certificates:
        name: traefik-certificates
